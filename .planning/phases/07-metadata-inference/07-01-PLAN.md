---
phase: 07-metadata-inference
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - metadata_parser.py
autonomous: true

must_haves:
  truths:
    - "User passes a ballot file path and system extracts province name from it"
    - "System extracts constituency number from file path (e.g., เขตเลือกตั้งที่ 4 -> 4)"
    - "System validates extracted province against ECT's 77 official provinces"
    - "System normalizes Thai Unicode in paths for consistent comparison"
  artifacts:
    - path: "metadata_parser.py"
      provides: "PathMetadataParser class with Thai regex patterns and NFC normalization"
      exports: ["PathMetadataParser", "InferredMetadata"]
      min_lines: 100
    - path: "metadata_parser.py"
      provides: "Province validation using ect_data.validate_province_name()"
      contains: "validate_province_name"
  key_links:
    - from: "metadata_parser.py"
      to: "ect_api.py"
      via: "from ect_api import ect_data"
      pattern: "ect_data\\.validate_province_name"
    - from: "metadata_parser.py"
      to: "unicodedata"
      via: "import unicodedata"
      pattern: "unicodedata\\.normalize\\('NFC'"
---

<objective>
Create PathMetadataParser class to extract province and constituency metadata from Thai ballot file paths.

Purpose: Reduce OCR burden by pre-filling metadata from file paths before AI extraction
Output: metadata_parser.py with PathMetadataParser and InferredMetadata classes
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-metadata-inference/07-RESEARCH.md

# Reference implementations
@download_ballots.py
@ect_api.py
@gdrivedl.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InferredMetadata dataclass</name>
  <files>metadata_parser.py</files>
  <action>
Create metadata_parser.py with InferredMetadata dataclass containing:
- province: Optional[str] = None
- constituency_number: Optional[int] = None
- district: Optional[str] = None
- subdistrict: Optional[str] = None
- polling_unit: Optional[int] = None
- form_type: Optional[str] = None (values: 'constituency' or 'party_list')
- source: str = "path" (tracks whether data came from path or OCR fallback)
- confidence: float = 0.0 (0.0 to 1.0)

Include imports: dataclass, Optional from dataclasses and typing.
Add docstring explaining this is metadata extracted from file path, not OCR.
  </action>
  <verify>python3 -c "from metadata_parser import InferredMetadata; m = InferredMetadata(province='Bangkok'); print(m)"</verify>
  <done>InferredMetadata dataclass exists and can be instantiated with optional fields</done>
</task>

<task type="auto">
  <name>Task 2: Create PathMetadataParser with Thai regex patterns</name>
  <files>metadata_parser.py</files>
  <action>
Add PathMetadataParser class to metadata_parser.py with:

1. Thai regex patterns as class constants:
   - CONSTITUENCY_PATTERN = re.compile(r'เขตเลือกตั้งที่\s*(\d+)')
   - DISTRICT_PATTERN = re.compile(r'อําเภอ([^/]+)')
   - SUBDISTRICT_PATTERN = re.compile(r'ตําบล([^/]+)')
   - POLLING_UNIT_PATTERN = re.compile(r'หน่วยเลือกตั้งที่\s*(\d+)')
   - PROVINCE_IN_PATH_PATTERN = re.compile(r'จังหวัด([^/]+)')

2. normalize_thai() method:
   - Use unicodedata.normalize('NFC', text) for consistent Thai character comparison
   - NOT NFKD (which is for filename sanitization in gdrivedl.py)

3. parse_path(file_path: str) -> InferredMetadata method:
   - Normalize path with normalize_thai()
   - Extract constituency number using CONSTITUENCY_PATTERN
   - Extract district/subdistrict using DISTRICT/SUBDISTRICT patterns
   - Extract polling unit using POLLING_UNIT_PATTERN
   - Extract form type from filename ('(บช)' = party_list, '5ทับ18'/'5/18' = constituency)
   - Calculate confidence: +0.3 for province, +0.2 for constituency, +0.1 for district

Reference the existing extract_metadata_from_path() in download_ballots.py lines 27-66 for patterns.
Import re and unicodedata at the top.
  </action>
  <verify>python3 -c "from metadata_parser import PathMetadataParser; p = PathMetadataParser(); m = p.parse_path('ballots/Phrae/เขตเลือกตั้งที่ 1 จังหวัดแพร่/อําเภอสูงเม่น/สส5ทับ18.pdf'); print(f'constituency={m.constituency_number}, district={m.district}')" | grep "constituency=1, district=สูงเม่น"</verify>
  <done>PathMetadataParser.parse_path() extracts constituency number and district from Thai path patterns</done>
</task>

<task type="auto">
  <name>Task 3: Add province validation against ECT list</name>
  <files>metadata_parser.py</files>
  <action>
Enhance PathMetadataParser with province extraction and validation:

1. In __init__:
   - Import ect_data from ect_api
   - Call ect_data.load() to ensure province list is available

2. In parse_path(), add province extraction:
   - Try PROVINCE_IN_PATH_PATTERN first (e.g., "จังหวัดแพร่")
   - If matched, validate using ect_data.validate_province_name(match.group(1).strip())
   - If valid, set metadata.province to the canonical name returned by ECT
   - Add +0.3 to confidence if province validated

3. Add extract_province_from_parent_dir(file_path: str) -> Optional[str] method:
   - Get immediate parent directory name using Path(file_path).parent.name
   - Normalize with NFC
   - Validate against ect_data.validate_province_name()
   - Return canonical name if valid, None otherwise

This ensures only valid Thai provinces (from ECT's 77 official provinces) are stored.
  </action>
  <verify>python3 -c "from metadata_parser import PathMetadataParser; p = PathMetadataParser(); m = p.parse_path('ballots/เชียงใหม่/เขตเลือกตั้งที่ 1/จังหวัดเชียงใหม่/test.pdf'); print(f'province={m.province}, valid={m.province is not None}')" | grep "province=เชียงใหม่, valid=True"</verify>
  <done>PathMetadataParser validates province names against ECT official list and stores canonical Thai name</done>
</task>

</tasks>

<verification>
1. metadata_parser.py exists and is importable
2. InferredMetadata dataclass has all required fields with correct types
3. PathMetadataParser.parse_path() extracts constituency from Thai patterns
4. PathMetadataParser normalizes paths with NFC for consistent comparison
5. Province validation uses ect_data.validate_province_name() for official list
6. Confidence scoring accumulates based on extracted fields
</verification>

<success_criteria>
- InferredMetadata dataclass exists with province, constituency_number, district, form_type, source, confidence fields
- PathMetadataParser class extracts metadata from Thai file paths using regex patterns
- Province names are validated against ECT's 77 official provinces
- Unicode NFC normalization ensures consistent Thai character comparison
</success_criteria>

<output>
After completion, create `.planning/phases/07-metadata-inference/07-01-SUMMARY.md`
</output>
