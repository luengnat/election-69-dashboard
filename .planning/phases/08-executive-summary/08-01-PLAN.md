---
phase: 08-executive-summary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ballot_ocr.py
  - web_ui.py
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can generate a one-page executive summary PDF from any batch result"
    - "Executive summary displays total ballots processed count and batch metadata"
    - "Executive summary includes discrepancy summary organized by severity level"
    - "Executive summary includes a bar chart showing top 5 parties by total votes"
    - "User can download executive summary PDF directly from web UI"
  artifacts:
    - path: "ballot_ocr.py"
      provides: "generate_one_page_executive_summary_pdf function"
      contains: "def generate_one_page_executive_summary_pdf"
    - path: "ballot_ocr.py"
      provides: "Top 5 parties horizontal bar chart helper"
      contains: "_create_top_parties_chart"
    - path: "web_ui.py"
      provides: "Executive summary download button"
      contains: "download_executive_summary_pdf"
  key_links:
    - from: "web_ui.py"
      to: "ballot_ocr.py"
      via: "import and call generate_one_page_executive_summary_pdf"
      pattern: "from ballot_ocr import.*generate_one_page_executive_summary"
    - from: "generate_one_page_executive_summary_pdf"
      to: "AggregatedResults"
      via: "aggregates party_totals from all_results"
      pattern: "party_totals\\.items\\(\\)"
    - from: "generate_one_page_executive_summary_pdf"
      to: "BatchResult"
      via: "extracts timing and batch metadata"
      pattern: "batch_result\\.(processed|duration_seconds)"
---

<objective>
Create a one-page executive summary PDF with key batch statistics, discrepancy summary, and a top 5 parties bar chart. Refactor existing multi-page executive summary into a compact single-page format.

Purpose: Provide users with a quick, printable overview of batch processing results on a single page.
Output: One-page executive summary PDF generation and web UI download button.
</objective>

<execution_context>
@/Users/nat/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nat/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

## Research Summary

From `.planning/phases/08-executive-summary/08-RESEARCH.md`:

**Key constraints for one-page layout:**
- Tight margins: 0.5 inch on all sides
- Smaller fonts: 8-10pt for body, 14pt for title
- Single chart: top 5 parties only, height ~2 inches
- Use HorizontalBarChart for better Thai party name labels
- No PageBreak()
- 2-column compact tables

**Existing patterns to reuse:**
- `generate_executive_summary_pdf()` at lines 2557-2784 (multi-page, will be refactored)
- `_create_votes_bar_chart()` at lines 2094-2138 (chart helper pattern)
- `generate_pdfs()` in web_ui.py at lines 240-291 (PDF generation pattern)
- `download_batch_pdf()` at lines 379-394 (download handler pattern)

**Data sources:**
- `AggregatedResults` dataclass: `party_totals`, `valid_votes_total`, `aggregated_confidence`, `discrepancy_rate`
- `BatchResult` dataclass: `processed`, `duration_seconds`, `start_time`, `end_time`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create one-page executive summary PDF function</name>
  <files>ballot_ocr.py</files>
  <action>
Add a new function `generate_one_page_executive_summary_pdf()` after the existing `generate_executive_summary_pdf()` function (around line 2785).

The function must accept:
- `all_results: list[AggregatedResults]` - aggregated constituency results
- `batch_result: BatchResult` - batch timing/metadata
- `output_path: str` - PDF output path

Implementation requirements:

1. **Compact document setup:**
   - Use `SimpleDocTemplate` with `letter` pagesize
   - Set tight margins: 0.5*inch on all sides
   - Use `getSampleStyleSheet()` for base styles

2. **Title and timestamp (compact):**
   - Title: "Electoral Results - Executive Summary" (14pt, centered)
   - Single line with generation timestamp

3. **Compact 2-column stats table:**
   - Create helper `_create_compact_stats_table()` that returns a 4-column table:
     - Row 1: Total Ballots | value | Total Provinces | value
     - Row 2: Valid Votes | value | Avg Confidence | value
     - Row 3: Invalid Votes | value | Processing Time | value
   - Font size: 8pt, minimal padding (4pt top/bottom)
   - Label columns with light gray background

4. **Discrepancy summary (inline, color-coded):**
   - Create helper `_format_discrepancy_summary_inline()` that returns a Paragraph
   - Count by severity: CRITICAL (>50%), MEDIUM (25-50%), LOW (0-25%), NONE (0%)
   - Use inline HTML with color coding:
     - CRITICAL: #e74c3c (red)
     - MEDIUM: #f39c12 (orange)
     - LOW: #3498db (blue)
     - NONE: #2ecc71 (green)
   - Format: "Discrepancy Summary: CRITICAL: X | MEDIUM: X | LOW: X | NONE: X"

5. **Top 5 parties horizontal bar chart:**
   - Create helper `_create_top_parties_chart()` using `HorizontalBarChart` from reportlab.graphics.charts.barcharts
   - Aggregate party_totals across all_results
   - Sort by votes descending, take top 5
   - Set explicit dimensions: width=5*inch, height=2*inch
   - Leave 80pt left margin for party labels
   - Use bar color #1f4788

6. **Footer with batch metadata:**
   - Single line: "Batch processed: {batch_result.processed} ballots in {batch_result.duration_seconds:.1f}s"
   - Smaller font (7pt), italic

7. **Build story without PageBreak():**
   - Elements: title, spacer, stats table, spacer, discrepancy line, spacer, chart, spacer, footer
   - Use small spacers (0.1*inch) between elements

DO NOT modify the existing `generate_executive_summary_pdf()` - keep it for backward compatibility.
  </action>
  <verify>
Run Python syntax check:
```bash
python -c "from ballot_ocr import generate_one_page_executive_summary_pdf; print('Import OK')"
```
  </verify>
  <done>
Function `generate_one_page_executive_summary_pdf` exists in ballot_ocr.py and accepts (all_results, batch_result, output_path) parameters. No PageBreak() calls in function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add web UI download button for executive summary</name>
  <files>web_ui.py</files>
  <action>
Add executive summary download functionality to web_ui.py.

1. **Import the new function:**
   - Add `generate_one_page_executive_summary_pdf` to imports from ballot_ocr
   - Add `BatchResult` to imports from batch_processor (if not already imported)

2. **Add download handler function (around line 415):**
```python
def download_executive_summary_pdf(ballot_results: list[BallotData]) -> Optional[str]:
    """
    Download handler for one-page executive summary PDF.

    Args:
        ballot_results: List of BallotData objects from state

    Returns:
        Path to executive summary PDF file or None if no results
    """
    if not ballot_results:
        logger.warning("No ballot results available for executive summary PDF")
        return None

    try:
        # Create temp directory
        pdf_dir = tempfile.mkdtemp(prefix="exec_summary_")

        # Aggregate results
        aggregated = aggregate_ballot_results(ballot_results)
        all_results = list(aggregated.values())

        # Create BatchResult from ballot_results metadata
        batch_result = BatchResult(
            results=ballot_results,
            processed=len(ballot_results),
            total=len(ballot_results),
            duration_seconds=0.0  # Will be populated if available
        )

        # Generate executive summary
        pdf_path = os.path.join(pdf_dir, "executive_summary.pdf")
        if generate_one_page_executive_summary_pdf(all_results, batch_result, pdf_path):
            logger.info(f"Generated executive summary PDF: {pdf_path}")
            return pdf_path
        else:
            logger.error("Failed to generate executive summary PDF")
            return None
    except Exception as e:
        logger.exception(f"Error generating executive summary: {e}")
        return None
```

3. **Add download button to UI layout (in create_interface function):**
   - Find the existing download buttons section (around the batch/constituency PDF buttons)
   - Add a new button for executive summary:
```python
exec_summary_btn = gr.DownloadButton(
    label="Executive Summary (1 page)",
    variant="secondary"
)
```

4. **Wire up the click event:**
   - Find where download buttons are connected (look for `.click()` calls)
   - Add: `exec_summary_btn.click(fn=download_executive_summary_pdf, inputs=[ballot_state], outputs=exec_summary_btn)`

Note: The ballot_state variable should already exist from Phase 6 implementation - it holds the list of BallotData objects.
  </action>
  <verify>
Run Python syntax check and verify import:
```bash
python -c "from web_ui import download_executive_summary_pdf; print('Import OK')"
```
  </verify>
  <done>
Web UI has a "Executive Summary (1 page)" download button that calls download_executive_summary_pdf with ballot results.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify one-page executive summary PDF</name>
  <what-built>
One-page executive summary PDF generation with:
- Compact stats table (total ballots, provinces, votes, confidence, processing time)
- Color-coded discrepancy summary by severity
- Top 5 parties horizontal bar chart
- Web UI download button for executive summary
  </what-built>
  <how-to-verify>
1. Start the web interface:
   ```bash
   python web_ui.py
   ```

2. Upload a few ballot images (can use test images from ballots/ folder)

3. Process the ballots

4. Click the "Executive Summary (1 page)" download button

5. Open the downloaded PDF and verify:
   - [ ] PDF is exactly one page
   - [ ] Title shows "Electoral Results - Executive Summary"
   - [ ] Stats table shows total ballots processed count
   - [ ] Discrepancy summary shows counts by severity (CRITICAL/MEDIUM/LOW/NONE)
   - [ ] Bar chart shows top 5 parties by votes
   - [ ] Footer shows processing time
   - [ ] Timestamp is present
  </how-to-verify>
  <resume-signal>Type "approved" if all checklist items pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 8 complete when:
1. `generate_one_page_executive_summary_pdf()` function exists in ballot_ocr.py
2. Function accepts `list[AggregatedResults]`, `BatchResult`, and output path
3. Generated PDF fits on a single letter-size page
4. Web UI has "Executive Summary (1 page)" download button
5. Download produces valid one-page PDF with all required elements
</verification>

<success_criteria>
- [ ] User can generate a one-page executive summary PDF from any batch result
- [ ] Executive summary displays total ballots processed count and batch metadata
- [ ] Executive summary includes discrepancy summary organized by severity level
- [ ] Executive summary includes a bar chart showing top 5 parties by total votes
- [ ] User can download executive summary PDF directly from web UI
</success_criteria>

<output>
After completion, create `.planning/phases/08-executive-summary/08-01-SUMMARY.md`
</output>
